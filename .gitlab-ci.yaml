# GitLab CI/CD é…ç½®
stages:
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# ============================================
# CI éšæ®µï¼šå‰ç«¯æ¸¬è©¦
# ============================================
frontend:test:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "ğŸ” é–‹å§‹æ¸¬è©¦å‰ç«¯..."
    - cd frontend
    - npm ci
    - echo "âœ… ä¾è³´å®‰è£å®Œæˆ"
    - npm run build
    - echo "âœ… å‰ç«¯å»ºç½®æˆåŠŸ"
  artifacts:
    paths:
      - frontend/build/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CI éšæ®µï¼šå¾Œç«¯æ¸¬è©¦
# ============================================
backend:test:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "ğŸ” é–‹å§‹æ¸¬è©¦å¾Œç«¯..."
    - cd backend
    - npm ci
    - echo "âœ… ä¾è³´å®‰è£å®Œæˆ"
    - echo "âœ… å¾Œç«¯æª¢æŸ¥å®Œæˆï¼ˆNode.js ä¸éœ€è¦ç·¨è­¯ï¼‰"
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CI éšæ®µï¼šå‰ç«¯ Docker å»ºç½®æ¸¬è©¦
# ============================================
frontend:docker:test:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "ğŸ³ æ¸¬è©¦å‰ç«¯ Dockerfile..."
    - cd frontend
    - docker build -t frontend-test:${CI_COMMIT_SHORT_SHA} .
    - echo "âœ… å‰ç«¯ Docker å»ºç½®æˆåŠŸ"
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CI éšæ®µï¼šå¾Œç«¯ Docker å»ºç½®æ¸¬è©¦
# ============================================
backend:docker:test:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "ğŸ³ æ¸¬è©¦å¾Œç«¯ Dockerfile..."
    - cd backend
    - docker build -t backend-test:${CI_COMMIT_SHORT_SHA} .
    - echo "âœ… å¾Œç«¯ Docker å»ºç½®æˆåŠŸ"
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CD éšæ®µï¼šå»ºç½®ä¸¦æ¨é€å‰ç«¯ Docker æ˜ åƒæª”
# ============================================
frontend:docker:build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "ğŸ³ å»ºç½®å‰ç«¯ Docker æ˜ åƒæª”..."
    - cd frontend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/frontend:latest .
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
    - echo "âœ… å‰ç«¯æ˜ åƒæª”å·²æ¨é€åˆ° GitLab Registry"
  only:
    - main
  when: on_success

# ============================================
# CD éšæ®µï¼šå»ºç½®ä¸¦æ¨é€å¾Œç«¯ Docker æ˜ åƒæª”
# ============================================
backend:docker:build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "ğŸ³ å»ºç½®å¾Œç«¯ Docker æ˜ åƒæª”..."
    - cd backend
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/backend:latest .
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/backend:latest
    - echo "âœ… å¾Œç«¯æ˜ åƒæª”å·²æ¨é€åˆ° GitLab Registry"
  only:
    - main
  when: on_success

# ============================================
# CD éšæ®µï¼šéƒ¨ç½²å‰ç«¯åˆ° Vercelï¼ˆå¯é¸ï¼‰
# ============================================
frontend:deploy:vercel:
  stage: deploy
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache curl
    - npm install -g vercel
  script:
    - echo "ğŸš€ éƒ¨ç½²å‰ç«¯åˆ° Vercel..."
    - cd frontend
    - vercel --prod --token $VERCEL_TOKEN --yes
    - echo "âœ… å‰ç«¯å·²éƒ¨ç½²åˆ° Vercel"
  environment:
    name: production
    url: $VERCEL_URL
  only:
    - main
  when: on_success
  needs:
    - frontend:docker:build

# ============================================
# CD éšæ®µï¼šéƒ¨ç½²å¾Œç«¯åˆ° Railwayï¼ˆå¯é¸ï¼‰
# ============================================
backend:deploy:railway:
  stage: deploy
  # ä½¿ç”¨ Railway å®˜æ–¹ CLI Docker æ˜ åƒ
  image: ghcr.io/railwayapp/cli:latest
  before_script:
    - echo "ğŸ” é©—è­‰ Railway èªè­‰..."
    # ä½¿ç”¨ RAILWAY_TOKEN é€²è¡Œèªè­‰é©—è­‰
    - railway whoami --token "$RAILWAY_TOKEN" || (echo "âš ï¸ ç„¡æ³•é©—è­‰ Railway èªè­‰ï¼Œè«‹æª¢æŸ¥ RAILWAY_TOKEN" && exit 1)
  script:
    - echo "ğŸš€ éƒ¨ç½²å¾Œç«¯åˆ° Railway..."
    - cd backend
    # æ˜ç¢ºä½¿ç”¨ RAILWAY_TOKEN å’Œ RAILWAY_SERVICE_ID é€²è¡Œéƒ¨ç½²
    - railway up --service "$RAILWAY_SERVICE_ID" --token "$RAILWAY_TOKEN"
    - echo "âœ… å¾Œç«¯å·²éƒ¨ç½²åˆ° Railway"
  environment:
    name: production
    url: $RAILWAY_BACKEND_URL
  only:
    - main
  when: on_success