# GitLab CI/CD 配置
stages:
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# ============================================
# CI 階段：前端測試
# ============================================
frontend:test:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "🔍 開始測試前端..."
    - cd frontend
    - npm ci
    - echo "✅ 依賴安裝完成"
    - npm run build
    - echo "✅ 前端建置成功"
  artifacts:
    paths:
      - frontend/build/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CI 階段：後端測試
# ============================================
backend:test:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "🔍 開始測試後端..."
    - cd backend
    - npm ci
    - echo "✅ 依賴安裝完成"
    - echo "✅ 後端檢查完成（Node.js 不需要編譯）"
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CI 階段：前端 Docker 建置測試
# ============================================
frontend:docker:test:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "🐳 測試前端 Dockerfile..."
    - cd frontend
    - docker build -t frontend-test:${CI_COMMIT_SHORT_SHA} .
    - echo "✅ 前端 Docker 建置成功"
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CI 階段：後端 Docker 建置測試
# ============================================
backend:docker:test:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "🐳 測試後端 Dockerfile..."
    - cd backend
    - docker build -t backend-test:${CI_COMMIT_SHORT_SHA} .
    - echo "✅ 後端 Docker 建置成功"
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CD 階段：建置並推送前端 Docker 映像檔
# ============================================
frontend:docker:build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "🐳 建置前端 Docker 映像檔..."
    - cd frontend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/frontend:latest .
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
    - echo "✅ 前端映像檔已推送到 GitLab Registry"
  only:
    - main
  when: on_success

# ============================================
# CD 階段：建置並推送後端 Docker 映像檔
# ============================================
backend:docker:build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "🐳 建置後端 Docker 映像檔..."
    - cd backend
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/backend:latest .
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/backend:latest
    - echo "✅ 後端映像檔已推送到 GitLab Registry"
  only:
    - main
  when: on_success

# ============================================
# CD 階段：部署前端到 Vercel（可選）
# ============================================
frontend:deploy:vercel:
  stage: deploy
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache curl
    - npm install -g vercel
  script:
    - echo "🚀 部署前端到 Vercel..."
    - cd frontend
    - vercel --prod --token $VERCEL_TOKEN --yes
    - echo "✅ 前端已部署到 Vercel"
  environment:
    name: production
    url: $VERCEL_URL
  only:
    - main
  when: on_success
  needs:
    - frontend:docker:build

# ============================================
# CD 階段：部署後端到 Railway（可選）
# ============================================
backend:deploy:railway:
  stage: deploy
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache curl bash
    - echo "安裝 Railway CLI..."
    - npm install -g @railway/cli
    - echo "檢查 Railway CLI 安裝..."
    - npm list -g @railway/cli || echo "警告：無法列出已安裝的套件"
    - echo "測試 Railway CLI 命令..."
    - railway --version 2>&1 || echo "railway 命令不可用，將使用 npx"
  script:
    - echo "🚀 部署後端到 Railway..."
    - cd backend
    - echo "檢查必要環境變數..."
    - |
      if [ -z "$RAILWAY_TOKEN" ]; then
        echo "❌ RAILWAY_TOKEN 未設定！請在 GitLab CI/CD 變數中設定。"
        exit 1
      fi
      echo "✅ RAILWAY_TOKEN 已設定"
      if [ -n "$RAILWAY_SERVICE_ID" ]; then
        echo "✅ RAILWAY_SERVICE_ID 已設定: $RAILWAY_SERVICE_ID"
      else
        echo "⚠️  RAILWAY_SERVICE_ID 未設定，將嘗試自動部署"
      fi
    - echo "設定 Railway 認證環境變數..."
    - export RAILWAY_TOKEN=$RAILWAY_TOKEN
    - echo "開始部署到 Railway..."
    - |
      DEPLOY_SUCCESS=false
      
      # 方法 1: 使用全局 railway 命令（如果可用）
      if command -v railway >/dev/null 2>&1; then
        echo "嘗試方法 1: 使用全局 railway 命令..."
        if [ -n "$RAILWAY_SERVICE_ID" ]; then
          railway up --service $RAILWAY_SERVICE_ID 2>&1 && DEPLOY_SUCCESS=true || echo "方法 1 失敗"
        else
          railway up 2>&1 && DEPLOY_SUCCESS=true || echo "方法 1 失敗"
        fi
      fi
      
      # 方法 2: 使用 npx @railway/cli
      if [ "$DEPLOY_SUCCESS" = "false" ]; then
        echo "嘗試方法 2: 使用 npx @railway/cli..."
        if [ -n "$RAILWAY_SERVICE_ID" ]; then
          npx -y @railway/cli up --service $RAILWAY_SERVICE_ID 2>&1 && DEPLOY_SUCCESS=true || echo "方法 2 失敗"
        else
          npx -y @railway/cli up 2>&1 && DEPLOY_SUCCESS=true || echo "方法 2 失敗"
        fi
      fi
      
      # 如果所有方法都失敗
      if [ "$DEPLOY_SUCCESS" = "false" ]; then
        echo "❌ 所有部署方法都失敗了"
        echo "請檢查："
        echo "1. RAILWAY_TOKEN 是否正確設定"
        echo "2. RAILWAY_SERVICE_ID 是否正確設定（如果使用）"
        echo "3. Railway 專案是否已正確連結"
        echo "4. 是否有足夠的權限進行部署"
        exit 1
      fi
      
      echo "✅ 部署成功！"
    - echo "✅ 後端已部署到 Railway"
  environment:
    name: production
    url: $RAILWAY_BACKEND_URL
  only:
    - main
  when: on_success
  needs:
    - backend:docker:build