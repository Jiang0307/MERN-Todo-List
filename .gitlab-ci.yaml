# GitLab CI/CD é…ç½®
stages:
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# ============================================
# CI éšæ®µï¼šå‰ç«¯æ¸¬è©¦
# ============================================
frontend:test:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "ğŸ” é–‹å§‹æ¸¬è©¦å‰ç«¯..."
    - cd frontend
    - npm ci
    - echo "âœ… ä¾è³´å®‰è£å®Œæˆ"
    - npm run build
    - echo "âœ… å‰ç«¯å»ºç½®æˆåŠŸ"
  artifacts:
    paths:
      - frontend/build/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CI éšæ®µï¼šå¾Œç«¯æ¸¬è©¦
# ============================================
backend:test:
  stage: test
  image: node:${NODE_VERSION}-alpine
  script:
    - echo "ğŸ” é–‹å§‹æ¸¬è©¦å¾Œç«¯..."
    - cd backend
    - npm ci
    - echo "âœ… ä¾è³´å®‰è£å®Œæˆ"
    - echo "âœ… å¾Œç«¯æª¢æŸ¥å®Œæˆï¼ˆNode.js ä¸éœ€è¦ç·¨è­¯ï¼‰"
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CI éšæ®µï¼šå‰ç«¯ Docker å»ºç½®æ¸¬è©¦
# ============================================
frontend:docker:test:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "ğŸ³ æ¸¬è©¦å‰ç«¯ Dockerfile..."
    - cd frontend
    - docker build -t frontend-test:${CI_COMMIT_SHORT_SHA} .
    - echo "âœ… å‰ç«¯ Docker å»ºç½®æˆåŠŸ"
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CI éšæ®µï¼šå¾Œç«¯ Docker å»ºç½®æ¸¬è©¦
# ============================================
backend:docker:test:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  script:
    - echo "ğŸ³ æ¸¬è©¦å¾Œç«¯ Dockerfile..."
    - cd backend
    - docker build -t backend-test:${CI_COMMIT_SHORT_SHA} .
    - echo "âœ… å¾Œç«¯ Docker å»ºç½®æˆåŠŸ"
  only:
    - main
    - develop
    - merge_requests

# ============================================
# CD éšæ®µï¼šå»ºç½®ä¸¦æ¨é€å‰ç«¯ Docker æ˜ åƒæª”
# ============================================
frontend:docker:build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "ğŸ³ å»ºç½®å‰ç«¯ Docker æ˜ åƒæª”..."
    - cd frontend
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/frontend:latest .
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/frontend:latest
    - echo "âœ… å‰ç«¯æ˜ åƒæª”å·²æ¨é€åˆ° GitLab Registry"
  only:
    - main
  when: on_success

# ============================================
# CD éšæ®µï¼šå»ºç½®ä¸¦æ¨é€å¾Œç«¯ Docker æ˜ åƒæª”
# ============================================
backend:docker:build:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "ğŸ³ å»ºç½®å¾Œç«¯ Docker æ˜ åƒæª”..."
    - cd backend
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/backend:latest .
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE/backend:latest
    - echo "âœ… å¾Œç«¯æ˜ åƒæª”å·²æ¨é€åˆ° GitLab Registry"
  only:
    - main
  when: on_success

# ============================================
# CD éšæ®µï¼šéƒ¨ç½²å‰ç«¯åˆ° Vercelï¼ˆå¯é¸ï¼‰
# ============================================
frontend:deploy:vercel:
  stage: deploy
  image: node:20-alpine
  before_script:
    - npm install -g vercel
  script:
    - cd frontend
    - |
      vercel deploy \
        --prod \
        --token "$VERCEL_TOKEN" \
        --project "$VERCEL_PROJECT_ID" \
        --org "$VERCEL_TEAM_ID" \
        --yes
  only:
    - main
  when: on_success

# ============================================
# CD éšæ®µï¼šéƒ¨ç½²å¾Œç«¯åˆ° Railwayï¼ˆå¯é¸ï¼‰
# ============================================
backend:deploy:railway:
  stage: deploy
  image: ghcr.io/railwayapp/cli:latest
  script:
    - cd backend
    - echo "ğŸš€ ä½¿ç”¨ Token éƒ¨ç½²åˆ° Railwayï¼ˆç„¡ç™»å…¥ã€ç„¡æª”æ¡ˆï¼‰..."
    - RAILWAY_TOKEN="$RAILWAY_TOKEN" railway up --service "$RAILWAY_SERVICE_ID"
  environment:
    name: production
    url: $RAILWAY_BACKEND_URL
  only:
    - main
  when: on_success