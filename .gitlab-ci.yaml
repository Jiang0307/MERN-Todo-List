stages:
    - test
      - build

variables:
    NODE_VERSION: "18"

# å‰ç«¯æ¸¬è©¦
frontend:test:
    stage: test
    image: node:${NODE_VERSION}-alpine
    script:
        - echo "ğŸ” é–‹å§‹æ¸¬è©¦å‰ç«¯..."
        - cd frontend
        - npm ci
        - npm run build
        - echo "âœ… å‰ç«¯æ¸¬è©¦å®Œæˆ"
    artifacts:
        paths:
            - frontend/build/
        expire_in: 1 hour
    only:
        - main

# å¾Œç«¯æ¸¬è©¦
backend:test:
    stage: test
    image: node:${NODE_VERSION}-alpine
    script:
        - echo "ğŸ” é–‹å§‹æ¸¬è©¦å¾Œç«¯..."
        - cd backend
        - npm ci
        - echo "âœ… å¾Œç«¯æ¸¬è©¦å®Œæˆ"
    only:
        - main

# Docker å»ºç½®æ¸¬è©¦
frontend:docker:test:
    stage: test
    image: docker:24
    services:
        - docker:24-dind
    script:
        - echo "ğŸ³ æ¸¬è©¦å‰ç«¯ Dockerfile..."
        - docker build -t frontend-test ./frontend
        - echo "âœ… å‰ç«¯ Docker å»ºç½®æˆåŠŸ"
    only:
        - main

backend:docker:test:
    stage: test
    image: docker:24
    services:
        - docker:24-dind
    script:
        - echo "ğŸ³ æ¸¬è©¦å¾Œç«¯ Dockerfile..."
        - docker build -t backend-test ./backend
        - echo "âœ… å¾Œç«¯ Docker å»ºç½®æˆåŠŸ"
    only:
        - main

# å»ºç½®ä¸¦æ¨é€ Docker æ˜ åƒæª”ï¼ˆéœ€è¦ GitLab Container Registryï¼‰
frontend:docker:build:
    stage: build
    image: docker:24
    services:
        - docker:24-dind
    before_script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    script:
        - echo "ğŸ³ å»ºç½®å‰ç«¯ Docker æ˜ åƒæª”..."
        - cd frontend
        - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/frontend:latest .
        - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHORT_SHA
        - docker push $CI_REGISTRY_IMAGE/frontend:latest
        - echo "âœ… å‰ç«¯æ˜ åƒæª”å·²æ¨é€åˆ° GitLab Registry"
    only:
        - main
    when: on_success

backend:docker:build:
    stage: build
    image: docker:24
    services: docker:24-dind
    before_script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    script:
        - echo "ğŸ³ å»ºç½®å¾Œç«¯ Docker æ˜ åƒæª”..."
        - cd backend
        - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE/backend:latest .
        - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHORT_SHA
        - docker push $CI_REGISTRY_IMAGE/backend:latest
        - echo "âœ… å¾Œç«¯æ˜ åƒæª”å·²æ¨é€åˆ° GitLab Registry"
    only:
        - main
    when: on_success
